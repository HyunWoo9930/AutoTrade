# 백테스팅 가이드

## 🎯 백테스팅이란?

과거 데이터로 전략을 테스트해서:
- **수익률**: 얼마나 벌었는지
- **승률**: 승/패 비율
- **MDD**: 최대 낙폭 (Maximum Drawdown)
- **샤프 비율**: 위험 대비 수익률

이런 지표들을 확인하는 거예요!

---

## 📊 백테스팅 시스템 구조

```
backtest.py
├─ Backtester 클래스
│  ├─ get_historical_data()    # 과거 데이터 조회
│  ├─ simulate_buy()            # 매수 시뮬레이션
│  ├─ simulate_sell()           # 매도 시뮬레이션
│  ├─ run()                     # 백테스트 실행
│  └─ analyze_results()         # 결과 분석
│
└─ 출력
   ├─ 수익률 분석 (총 수익률, MDD, 샤프비율)
   ├─ 매매 통계 (승률, 평균 수익/손실)
   └─ JSON 결과 파일 저장
```

---

## 🚀 사용 방법

### 1. 서버 접속

```bash
ssh ec2-user@your-server-ip
cd /path/to/stock_trading
```

### 2. 백테스팅 실행

```bash
# 기본 실행 (최근 6개월)
python3 code/backtest.py

# 결과 확인
cat data/backtest_result_*.json | jq .
```

### 3. 기간 변경

`backtest.py` 맨 아래 수정:

```python
# 1년 전부터 테스트
start_date = (datetime.now() - timedelta(days=365)).strftime('%Y%m%d')

# 2024년 전체
start_date = "20240101"
end_date = "20241231"
```

---

## 📈 결과 해석

### 출력 예시

```
📈 **수익률 분석**
  초기 자본: 30,000,000원
  최종 자산: 33,450,000원
  총 수익률: +11.50%
  최대 낙폭(MDD): 8.2%
  샤프 비율: 1.35

💼 **매매 통계**
  총 거래: 45회
  승: 28회 | 패: 17회
  승률: 62.2%
  평균 수익: +8.5%
  평균 손실: -4.2%
  손익비: 2.02

⏱️ **보유 기간**
  평균: 12.3일
  최소: 3일
  최대: 45일
```

### 해석

✅ **좋은 지표**:
- 수익률 > 10%
- MDD < 15%
- 샤프 비율 > 1.0
- 승률 > 55%
- 손익비 > 1.5

❌ **나쁜 지표**:
- 수익률 < 0%
- MDD > 25% (큰 손실)
- 샤프 비율 < 0.5
- 승률 < 45%
- 손익비 < 1.0

---

## 🔧 커스터마이징

### 1. 테스트 종목 변경

```python
# backtest.py 맨 아래
stocks = [
    ("005930", "삼성전자"),
    ("000660", "SK하이닉스"),
    ("035420", "NAVER")
]
```

### 2. 초기 자본 변경

```python
backtester = Backtester(initial_cash=50000000)  # 5천만원
```

### 3. 최대 보유 종목 수 변경

```python
# backtest.py의 simulate_buy 조건
elif len(self.positions) < 5:  # 5개로 제한
```

---

## 📊 결과 분석 팁

### 1. MDD (Maximum Drawdown)

```
최고점에서 최저점까지 하락폭

예시:
- 자산 최고점: 3,500만원
- 최저점: 3,200만원
- MDD = (3,500 - 3,200) / 3,500 = 8.6%
```

**의미**:
- MDD 10% → 최대 10% 손실 감수 필요
- MDD 5% → 매우 안정적
- MDD 30% → 위험 높음

### 2. 샤프 비율 (Sharpe Ratio)

```
위험 대비 수익률 지표

계산: (평균 수익률 - 무위험 이자율) / 변동성
```

**기준**:
- < 0.5: 나쁨
- 0.5 ~ 1.0: 보통
- 1.0 ~ 2.0: 좋음
- > 2.0: 매우 좋음

### 3. 손익비 (Profit Factor)

```
손익비 = (평균 수익 × 승리 횟수) / (평균 손실 × 패배 횟수)
```

**예시**:
- 평균 수익: +8%
- 승리 횟수: 30회
- 평균 손실: -4%
- 패배 횟수: 20회
- 손익비 = (8 × 30) / (4 × 20) = 3.0

**기준**:
- > 2.0: 매우 좋음
- 1.5 ~ 2.0: 좋음
- 1.0 ~ 1.5: 보통
- < 1.0: 나쁨 (손실이 더 큼)

---

## ⚠️ 주의사항

### 1. 과최적화 (Overfitting)

백테스팅 결과가 너무 좋으면 의심!

```
백테스팅: +50% 수익률
실전: -10% 손실

→ 과거 데이터에만 최적화됨
```

**해결책**:
- 여러 기간으로 테스트
- 다양한 종목으로 테스트
- Out-of-sample 테스트

### 2. 슬리피지 (Slippage)

```
백테스팅: 호가 그대로 체결
실전: 호가 미끄러짐, 체결 안 됨
```

**현실**:
- 체결가 차이 (±0.5~1%)
- 체결 지연
- 유동성 부족

### 3. 수수료 & 세금

```
백테스팅에서 누락되기 쉬운 비용:
- 매매 수수료: 0.015%
- 증권거래세: 0.23%
- 제세공과금

→ 매매당 약 0.5% 비용 발생
```

---

## 🎯 백테스팅 체크리스트

### 실행 전

- [ ] 테스트 기간 설정 (최소 6개월 권장)
- [ ] 초기 자본 설정
- [ ] 테스트 종목 선정

### 실행 중

- [ ] API 레이트 리밋 확인 (1초당 1회)
- [ ] 데이터 누락 체크
- [ ] 진행 상황 모니터링

### 결과 분석

- [ ] 수익률 > 10%?
- [ ] MDD < 15%?
- [ ] 샤프 비율 > 1.0?
- [ ] 승률 > 50%?
- [ ] 손익비 > 1.5?

**5개 중 3개 이상 통과** → 실전 고려 가능
**2개 이하** → 전략 재검토 필요

---

## 📁 결과 파일 구조

### `data/backtest_result_YYYYMMDD_HHMMSS.json`

```json
{
  "config": {
    "initial_cash": 30000000,
    "final_cash": 25000000,
    "positions": 2
  },
  "trades": [
    {
      "date": "20240315",
      "action": "BUY",
      "stock_code": "005930",
      "stock_name": "삼성전자",
      "price": 75000,
      "qty": 100,
      "cost": 7500000,
      "signals": 4,
      "regime": "trending"
    },
    {
      "date": "20240325",
      "action": "SELL",
      "stock_code": "005930",
      "stock_name": "삼성전자",
      "price": 82000,
      "qty": 100,
      "revenue": 8200000,
      "profit_rate": 9.33,
      "profit_amount": 700000,
      "reason": "1차 익절 (+10%)",
      "hold_days": 10
    }
  ],
  "equity_curve": [
    {
      "date": "20240301",
      "cash": 30000000,
      "portfolio": 0,
      "total": 30000000,
      "positions": 0
    },
    {
      "date": "20240315",
      "cash": 22500000,
      "portfolio": 7500000,
      "total": 30000000,
      "positions": 1
    }
  ]
}
```

---

## 🔍 개선 아이디어

### 현재 한계점

1. **간소화된 신호 계산**
   - 실제 전략보다 단순함
   - 가중치 미적용

2. **피라미드 매수 미구현**
   - 2차 추가 매수 없음

3. **트레일링 스탑 미구현**
   - 최고점 추적 없음

### 개선 방안

```python
# 1. 실제 전략 적용
signals = self.strategy.check_buy_signals(stock_code)
regime, regime_info = self.strategy.detect_market_regime(stock_code)

# 2. 피라미드 매수 구현
if profit_rate >= 3.0 and position['remaining_qty'] > 0:
    self.simulate_pyramid_buy(...)

# 3. 트레일링 스탑 구현
if profit_rate >= 15.0:
    peak = self.peak_profit.get(stock_code, 0)
    if peak - profit_rate >= 3.0:
        self.simulate_sell(...)
```

---

## 🚀 다음 단계

1. **로컬 테스트** (현재 단계)
   ```bash
   # 서버에서 실행
   python3 code/backtest.py
   ```

2. **결과 확인**
   ```bash
   # JSON 결과 보기
   cat data/backtest_result_*.json | jq .

   # 최신 결과만
   ls -t data/backtest_result_*.json | head -1 | xargs cat | jq .
   ```

3. **전략 조정**
   - 수익률 낮으면 → 신호 임계치 조정
   - MDD 높으면 → 손절 강화
   - 승률 낮으면 → 매수 조건 강화

4. **재백테스팅**
   - 다른 기간으로 테스트
   - 다른 종목으로 테스트
   - Walk-forward 테스트

---

## 💡 실전 투입 기준

### ✅ 백테스팅 통과 기준

- 총 수익률 > +15% (6개월 기준)
- MDD < 12%
- 샤프 비율 > 1.2
- 승률 > 55%
- 손익비 > 1.8

### ⚠️ 실전 주의사항

1. **소액으로 시작** (500만원 ~ 1천만원)
2. **1주일 모니터링** (백테스팅과 실전 비교)
3. **손절 엄수** (백테스팅보다 빡세게)
4. **주간 리뷰** (매주 성과 점검)

### 🛑 중단 기준

- 2주 연속 손실
- MDD > 20% 도달
- 전략 로직 에러 발생

---

**작성일**: 2025-10-14
**작성자**: Claude Code
**버전**: 1.0.0
